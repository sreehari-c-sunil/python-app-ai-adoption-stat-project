{% extends "layout.html" %}
{% block title %}Analysis Results{% endblock %}
{% block content %}

<div class="page-header">
    <h1>Statistical Analysis Results</h1>
    <p class="subtitle">Based on {{ total_rows }} student responses</p>
</div>

<!-- 1. DESCRIPTIVE STATISTICS -->
<div class="section">
    <h2>1. Descriptive Statistics</h2>
    <p>Count, mean, standard deviation, min, max and quartiles for all numeric variables.</p>
    {{ desc_stats | safe }}
</div>

<!-- 2. FREQUENCY TABLES -->
{% if freq_tables %}
<div class="section">
    <h2>2. Frequency Tables</h2>
    <div class="freq-grid">
        {% for col, table_html in freq_tables.items() %}
        <div class="freq-card">
            <h4>{{ col.replace('_',' ').title() }}</h4>
            {{ table_html | safe }}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 3. VISUAL CHARTS -->
{% if charts %}
<div class="section">
    <h2>3. Visual Charts</h2>
    <div class="charts-grid">
        {% for chart in charts %}
        <div class="chart-card">
            <h4>{{ chart.title }}</h4>
            <img src="{{ url_for('static', filename=chart.path) }}" alt="{{ chart.title }}" class="chart-img">
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- 4. STATISTICAL TESTS -->
<div class="section">
    <h2>4. Statistical Tests</h2>
    <p>Each test shows: hypotheses, result, a one-line finding, and a one-line conclusion.</p>

    {% for result in results %}
    <div class="test-card">
        {% if result.error %}
            <h3>{{ result.test_name }}</h3>
            <div class="alert alert-error">Could not run test: {{ result.error }}</div>
        {% else %}
        <div class="test-header">
            <h3>{{ result.test_name }}</h3>
            <span class="test-vars">{{ result.variables }}</span>
        </div>

        <div class="hypothesis-box">
            <div><strong>H0:</strong> {{ result.h0 }}</div>
            <div><strong>H1:</strong> {{ result.h1 }}</div>
        </div>

        <div class="test-stats">
            <div class="stat-item">
                <span class="stat-label">{{ result.stat_label }}</span>
                <span class="stat-value">{{ result.statistic }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">p-value</span>
                <span class="stat-value {{ 'significant' if result.p_value < 0.05 else 'not-significant' }}">
                    {{ result.p_value }}
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Decision</span>
                <span class="stat-value {{ 'reject' if result.decision == 'Reject H0' else 'fail-reject' }}">
                    {{ result.decision }}
                </span>
            </div>
            {% if result.group1_mean is defined %}
            <div class="stat-item">
                <span class="stat-label">{{ result.group1_label }}</span>
                <span class="stat-value">{{ result.group1_mean }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">{{ result.group2_label }}</span>
                <span class="stat-value">{{ result.group2_mean }}</span>
            </div>
            {% endif %}
        </div>

        {% if result.group_means is defined %}
        <div class="group-means">
            <strong>Group Means:</strong>
            {% for grp, mean in result.group_means.items() %}
                <span class="mean-pill">{{ grp }}: {{ mean }}</span>
            {% endfor %}
        </div>
        {% endif %}

        <!-- One-line finding -->
        <div class="inference-box">
            <strong>Finding:</strong> {{ result.inference }}
        </div>

        <!-- One-line conclusion -->
        <div class="conclusion-box">
            <strong>Conclusion:</strong> {{ result.conclusion }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- 5. SUMMARY P-VALUE CHART -->
{% if summary_chart %}
<div class="section">
    <h2>5. Statistical Tests Summary Chart</h2>
    <p>Green bars indicate statistically significant results (p &lt; 0.05). Grey bars indicate non-significant results. The red dashed line marks the 0.05 threshold.</p>
    <div class="chart-card" style="max-width:820px;">
        <img src="{{ url_for('static', filename=summary_chart) }}" alt="Summary p-value chart" class="chart-img">
    </div>
</div>
{% endif %}

<!-- 6. FINAL RESEARCH CONCLUSION -->
<div class="section">
    <h2>6. Final Research Conclusion</h2>
    <div class="final-conclusion-box">
        {{ final_conclusion }}
    </div>
</div>

<!-- 7. PRACTICAL OBSERVATIONS -->
<div class="section">
    <h2>7. Practical Observations &amp; Limitations</h2>
    {% for obs in observations %}
    <div class="observation {{ obs.type }}">
        <strong>{{ obs.title }}:</strong> {{ obs.detail }}
    </div>
    {% endfor %}
</div>

<div class="action-buttons">
    <a href="{{ url_for('upload') }}" class="btn btn-secondary">Upload New Data</a>
    <a href="{{ url_for('index') }}"  class="btn btn-secondary">Back to Home</a>
</div>

{% endblock %}
